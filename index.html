<!DOCTYPE html>
<html lang="tr">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9YQEJ7LN0E"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-9YQEJ7LN0E');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Leap: Final</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        body {
            margin: 0; overflow: hidden;
            background-color: #020204; color: white;
            font-family: 'Orbitron', sans-serif;
            touch-action: none; user-select: none; -webkit-user-select: none;
            transition: background-color 2s ease;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* UI */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 20;
            display: flex; flex-direction: column; align-items: center;
        }

        /* HUD */
        .top-hud {
            position: absolute; top: 20px; width: 100%;
            display: grid; grid-template-columns: 1fr auto 1fr;
            align-items: center; padding: 0 20px; box-sizing: border-box;
            pointer-events: auto;
        }
        .hud-left { display: flex; align-items: center; gap: 10px; justify-self: start; }
        .hud-center { text-align: center; }
        .hud-right { justify-self: end; display: flex; gap: 15px; }

        .score-box { font-size: 3rem; font-weight: 900; transition: color 0.5s; line-height: 1; }
        .level-indicator { font-size: 0.7rem; color: rgba(255,255,255,0.5); letter-spacing: 2px; }

        .shield-container {
            display: flex; align-items: center; gap: 8px;
            color: #00ff9d; font-size: 1.1rem; font-weight: bold;
            background: rgba(0, 255, 157, 0.1);
            padding: 8px 16px; border-radius: 30px; border: 1px solid rgba(0, 255, 157, 0.3);
            transition: all 0.3s;
        }
        .shield-active { transform: scale(1.3); background: rgba(0, 255, 157, 0.6); box-shadow: 0 0 30px #00ff9d; color: #000; }

        /* BUTONLAR */
        .icon-btn {
            background: transparent; border: none; color: rgba(255,255,255,0.6);
            font-size: 1.8rem; cursor: pointer; transition: 0.2s; padding: 0;
        }
        .icon-btn:hover { color: white; transform: scale(1.2); }

        /* MEN√úLER */
        .menu-screen {
            pointer-events: auto; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(10, 15, 25, 0.95); padding: 2rem;
            border-radius: 20px; border: 1px solid rgba(0, 242, 255, 0.3);
            text-align: center; display: flex; flex-direction: column; gap: 1rem;
            box-shadow: 0 0 60px rgba(0,0,0,0.8); min-width: 320px; max-width: 90%;
            backdrop-filter: blur(10px); z-index: 50;
        }
        h1 { margin: 0; font-size: 2.5rem; background: linear-gradient(to right, #00f2ff, #00ff9d); -webkit-background-clip: text; color: transparent; }
        
        .btn {
            background: rgba(0, 242, 255, 0.1); border: 2px solid #00f2ff; color: #00f2ff;
            padding: 15px 30px; font-size: 1.1rem; font-family: inherit; font-weight: bold;
            cursor: pointer; border-radius: 50px; transition: 0.2s; width: 100%;
        }
        .btn:hover { background: #00f2ff; color: black; box-shadow: 0 0 20px #00f2ff; }
        .btn-share { border-color: #00ff9d; color: #00ff9d; background: rgba(0, 255, 157, 0.1); }
        .btn-share:hover { background: #00ff9d; color: black; }
        .btn-secondary { border-color: #666; color: #aaa; font-size: 0.8rem; padding: 8px 16px; width: auto; }
        .hidden { display: none !important; }

        .result-box {
            background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 15px;
            margin-bottom: 15px; border: 1px dashed rgba(255,255,255,0.2);
        }
        .emoji-strip {
            font-size: 1.5rem; letter-spacing: 3px; margin: 10px 0; word-break: break-all;
            line-height: 1.4; text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        input[type="text"] {
            background: rgba(0,0,0,0.5); border: 2px solid #333; color: white;
            padding: 15px; font-family: 'Orbitron'; font-size: 1.2rem; text-align: center;
            border-radius: 10px; width: 80%; margin: 0 auto; outline: none;
        }

        .leaderboard-list { list-style: none; padding: 0; margin: 0; width: 100%; text-align: left; }
        .leaderboard-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; font-size: 0.9rem; }
        .leaderboard-item:nth-child(1) { color: #ffd700; font-weight: bold; text-shadow: 0 0 10px #ffd700; }
        .loading { color: #00f2ff; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .floating-text {
            position: absolute; font-weight: 900; pointer-events: none;
            animation: floatUp 1.2s forwards; text-shadow: 0 0 10px black; white-space: nowrap; font-size: 1.5rem; z-index: 10;
        }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-120px) scale(1.5); opacity: 0; } }

        #level-up-msg {
            position: absolute; top: 35%; width: 100%; text-align: center;
            font-size: 3rem; font-weight: 900; color: #fff;
            text-shadow: 0 0 20px currentColor; opacity: 0; pointer-events: none; transition: color 0.5s;
        }
        .levelup-anim { animation: levelUpPop 2.5s forwards; }
        @keyframes levelUpPop {
            0% { opacity: 0; transform: scale(0.5) translateY(50px); }
            15% { opacity: 1; transform: scale(1.2) translateY(0); }
            85% { opacity: 1; transform: scale(1) translateY(0); }
            100% { opacity: 0; transform: scale(1.5) translateY(-50px); }
        }

        /* SES KONTROL BUTONLARI GRUBU */
        .audio-controls {
            position: absolute; bottom: 20px; right: 20px; pointer-events: auto;
            display: flex; gap: 15px; z-index: 30;
        }
        .audio-btn {
            background: transparent; border: none; font-size: 1.8rem; opacity: 0.7; cursor: pointer;
            transition: transform 0.2s;
        }
        .audio-btn:hover { opacity: 1; transform: scale(1.1); }
        .audio-off { opacity: 0.3; filter: grayscale(100%); }

        #toast {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            background: #00ff9d; color: black; padding: 10px 20px;
            border-radius: 20px; font-weight: bold; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; z-index: 100;
        }
        .show-toast { opacity: 1 !important; bottom: 60px !important; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="top-hud">
            <div class="hud-left">
                <div id="shield-ui" class="shield-container">
                    <span>üõ°Ô∏è</span> <span id="shield-count">0</span>
                </div>
                <button id="show-leaderboard-btn" class="btn btn-secondary" style="border-radius: 20px;">üèÜ TOP 10</button>
            </div>

            <div class="hud-center">
                <div id="score" class="score-box">0</div>
                <div id="level-txt" class="level-indicator">SECTOR 1</div>
            </div>

            <div class="hud-right">
                <button id="fullscreen-btn" class="icon-btn" title="Tam Ekran">‚õ∂</button>
            </div>
        </div>

        <div id="level-up-msg">LEVEL UP!</div>

        <div id="start-screen" class="menu-screen">
            <h1>NEON LEAP</h1>
            <p style="color:#ccc; line-height: 1.6;">
                <span style="color:#ffaa00">üî• SERƒ∞ OYNA (Combo)</span><br>
                <span style="color:#00ff9d">üõ°Ô∏è 3 COMBO = 1 JOKER</span>
            </p>
            <button class="btn" id="start-btn">BA≈ûLAT</button>
        </div>

        <div id="game-over-screen" class="menu-screen hidden">
            <h2 style="color:#ff0055; margin:0;">G√ñREV SONU</h2>
            
            <div class="result-box">
                <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">G√ñREV RAPORU</div>
                <div id="share-preview" class="emoji-strip">...</div>
                <div style="display:flex; justify-content:space-around; align-items:center; margin-top:5px;">
                    <div style="font-size:2rem; font-weight:bold;" id="final-score">0</div>
                    <div style="color:#666; font-size:0.8rem;">EN ƒ∞Yƒ∞: <span id="best-score">0</span></div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; width: 100%;">
                <button class="btn btn-share" id="share-btn">üì§ PAYLA≈û</button>
            </div>
            
            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:15px 0; width:100%;">

            <div id="save-score-area">
                <p style="font-size:0.8rem; color:#aaa;">Lƒ∞DER TABLOSU ƒ∞√áƒ∞N ADINI YAZ:</p>
                <input type="text" id="player-name" placeholder="Pƒ∞LOT ADI" maxlength="15">
                <br><br>
                <button class="btn" id="save-score-btn" style="border-color:#00f2ff; color:#00f2ff;">KAYDET</button>
            </div>
            
            <div style="margin-top:15px;">
                <button class="btn" id="restart-btn" style="border-color:#666; color:#ccc;">TEKRAR DENE</button>
            </div>
        </div>

        <div id="leaderboard-screen" class="menu-screen hidden" style="z-index: 100;">
            <h2 style="color:#ffd700; margin-bottom: 10px;">üèÜ TOP 10 Pƒ∞LOT</h2>
            <div id="leaderboard-content" class="loading">Y√ºkleniyor...</div>
            <br>
            <button class="btn btn-secondary" id="close-leaderboard-btn">KAPAT</button>
        </div>
        
        <!-- SES KONTROLLERƒ∞ -->
        <div class="audio-controls">
            <button id="sfx-btn" class="audio-btn" title="Ses Efektleri">üîä</button>
            <button id="music-btn" class="audio-btn" title="M√ºzik">üéµ</button>
        </div>
    </div>

    <div id="toast">Kopyalandƒ±!</div>
    <textarea id="clipboard-helper" style="position:absolute; left:-9999px;"></textarea>
    <canvas id="gameCanvas"></canvas>

    <!-- FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCc4ERyMGvfAXF-dh_PRztFH707_9pKca0",
          authDomain: "neonleap-2bb89.firebaseapp.com",
          projectId: "neonleap-2bb89",
          storageBucket: "neonleap-2bb89.firebasestorage.app",
          messagingSenderId: "653143256534",
          appId: "1:653143256534:web:a92cc76688072e427bc877",
          measurementId: "G-9YQEJ7LN0E"
        };

        let db;
        try { 
            const app = initializeApp(firebaseConfig); 
            const analytics = getAnalytics(app); 
            db = getFirestore(app); 
        } catch(e){ console.error(e); }

        async function saveScoreToDB(name, score) {
            if (!db) return alert("Baƒülantƒ± hatasƒ±! Sayfayƒ± yenileyin.");
            if (!name) return alert("ƒ∞sim girin.");
            const btn = document.getElementById('save-score-btn');
            btn.innerText = "..."; btn.disabled = true;
            try {
                await addDoc(collection(db, "scores"), { name: name.toUpperCase(), score: score, date: new Date() });
                showToast("Kaydedildi!");
                document.getElementById('save-score-area').style.display = 'none';
                localStorage.setItem('neon_last_name', name);
                document.getElementById('leaderboard-screen').classList.remove('hidden');
                await fetchLeaderboard();
            } catch (e) { alert("Hata olu≈ütu."); } finally { btn.innerText = "KAYDET"; btn.disabled = false; }
        }

        async function fetchLeaderboard() {
            if (!db) return;
            const div = document.getElementById('leaderboard-content');
            div.innerHTML = '<div class="loading">Veriler √ßekiliyor...</div>';
            try {
                const q = query(collection(db, "scores"), orderBy("score", "desc"), limit(10));
                const snap = await getDocs(q);
                let html = '<ul class="leaderboard-list">';
                let i=1; snap.forEach(d => { html += `<li class="leaderboard-item"><span>#${i++} ${d.data().name}</span><span>${d.data().score}</span></li>`; });
                html += '</ul>';
                div.innerHTML = snap.empty ? "ƒ∞lk sen ol!" : html;
            } catch (e) { div.innerText = "Veri alƒ±namadƒ±."; }
        }

        document.getElementById('save-score-btn').addEventListener('click', ()=>{ saveScoreToDB(document.getElementById('player-name').value, window.gameScore); });
        document.getElementById('show-leaderboard-btn').addEventListener('click', ()=>{ document.getElementById('leaderboard-screen').classList.remove('hidden'); fetchLeaderboard(); });
        document.getElementById('close-leaderboard-btn').addEventListener('click', ()=>{ document.getElementById('leaderboard-screen').classList.add('hidden'); });
        const saved = localStorage.getItem('neon_last_name'); if(saved) document.getElementById('player-name').value = saved;
    </script>

    <!-- OYUN MOTORU -->
    <script>
        let gameHistory = [];
        const HISTORY_LIMIT = 10; 

        function logHistory(emoji) {
            gameHistory.push(emoji);
            if(gameHistory.length > HISTORY_LIMIT) gameHistory.shift();
        }

        const THEMES = [
            { score: 0,  name: "SECTOR 1", bg: "#020204", main: "#00f2ff", sec: "#00ff9d" },
            { score: 10, name: "SECTOR 2", bg: "#1a001a", main: "#ff00ff", sec: "#aa00ff" },
            { score: 25, name: "SECTOR 3", bg: "#1a0a00", main: "#ff5500", sec: "#ffaa00" },
            { score: 40, name: "THE VOID", bg: "#000000", main: "#ffffff", sec: "#555555" }
        ];
        let currentThemeIdx = 0;

        function spawnFloatingText(x, y, text, color) {
            const el = document.createElement('div');
            el.className = 'floating-text'; el.innerText = text;
            el.style.left = x + 'px'; el.style.top = y + 'px'; el.style.color = color;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1200);
        }

        function triggerLevelUp(idx) {
            const theme = THEMES[idx];
            document.body.style.backgroundColor = theme.bg;
            document.getElementById('score').style.color = theme.main;
            document.getElementById('level-txt').innerText = theme.name;
            const msg = document.getElementById('level-up-msg');
            msg.innerText = theme.name; msg.style.color = theme.main;
            msg.classList.remove('levelup-anim'); void msg.offsetWidth; msg.classList.add('levelup-anim');
            AudioSys.playSFX('levelup');
        }

        // --- SES ---
        const AudioSys = {
            ctx: null, tempo: 1200, isMusicOn: true, isSfxOn: true, beatCount: 0, timerID: null,
            
            init: function() { try { const AC = window.AudioContext || window.webkitAudioContext; if(AC && !this.ctx) this.ctx = new AC(); if(this.ctx.state === 'suspended') this.ctx.resume(); } catch(e){} },
            
            scheduleNextBeat: function() {
                if (!this.isMusicOn || gameState !== 'PLAYING') return;
                this.playBeat(this.ctx.currentTime);
                let currentTempo = Math.max(300, 1200 - (score * 15));
                this.timerID = setTimeout(() => this.scheduleNextBeat(), currentTempo);
            },
            
            playBeat: function(time) {
                this.beatCount++;
                // Kick
                if (this.beatCount % 4 === 0) {
                    const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                    o.connect(g); g.connect(this.ctx.destination);
                    o.type = 'sine'; o.frequency.setValueAtTime([110,130,146][Math.floor(Math.random()*3)], time);
                    g.gain.setValueAtTime(0, time); g.gain.linearRampToValueAtTime(0.1, time+1); g.gain.linearRampToValueAtTime(0, time+4);
                    o.start(time); o.stop(time+4);
                }
                if (score > 5) {
                    const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                    o.connect(g); g.connect(this.ctx.destination);
                    o.frequency.setValueAtTime(150, time); o.frequency.exponentialRampToValueAtTime(0.01, time+0.5);
                    g.gain.setValueAtTime(0.2, time); g.gain.exponentialRampToValueAtTime(0.01, time+0.5);
                    o.start(time); o.stop(time+0.5);
                }
                if (score > 20 && this.beatCount % 2 !== 0) {
                    const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                    o.connect(g); g.connect(this.ctx.destination);
                    o.type='square'; o.frequency.setValueAtTime(800, time);
                    g.gain.setValueAtTime(0.03, time); g.gain.exponentialRampToValueAtTime(0.01, time+0.05);
                    o.start(time); o.stop(time+0.05);
                }
            },
            
            startMusic: function() { if (this.timerID) clearTimeout(this.timerID); this.beatCount=0; this.scheduleNextBeat(); },
            stopMusic: function() { if (this.timerID) clearTimeout(this.timerID); },
            
            toggleMusic: function() {
                this.isMusicOn = !this.isMusicOn;
                const btn = document.getElementById('music-btn');
                btn.classList.toggle('audio-off', !this.isMusicOn);
                if(this.isMusicOn && gameState==='PLAYING') this.startMusic(); else this.stopMusic();
            },
            
            toggleSfx: function() {
                this.isSfxOn = !this.isSfxOn;
                document.getElementById('sfx-btn').classList.toggle('audio-off', !this.isSfxOn);
            },

            playSFX: function(type) {
                if(!this.ctx || !this.isSfxOn) return;
                const t = this.ctx.currentTime;
                const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                o.connect(g); g.connect(this.ctx.destination);
                
                if(type==='dock') { o.type='triangle'; o.frequency.setValueAtTime(300, t); o.frequency.exponentialRampToValueAtTime(50, t+0.15); g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.15); o.start(t); o.stop(t+0.15); }
                else if(type==='jump') { o.type='sawtooth'; o.frequency.setValueAtTime(100, t); o.frequency.linearRampToValueAtTime(400, t+0.3); g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.3); o.start(t); o.stop(t+0.3); }
                else if(type==='combo') { o.type='sine'; o.frequency.setValueAtTime(600, t); o.frequency.exponentialRampToValueAtTime(1200, t+0.2); g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t+0.2); o.start(t); o.stop(t+0.2); }
                else if(type==='shield_get') { o.type='square'; o.frequency.setValueAtTime(400, t); o.frequency.linearRampToValueAtTime(800, t+0.4); g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.4); o.start(t); o.stop(t+0.4); }
                else if(type==='recover') { o.type='sawtooth'; o.frequency.setValueAtTime(100, t); o.frequency.linearRampToValueAtTime(300, t+1.0); g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t+1.0); o.start(t); o.stop(t+1.0); }
                else if(type==='die') { o.type='sawtooth'; o.frequency.setValueAtTime(80, t); o.frequency.linearRampToValueAtTime(20, t+0.8); g.gain.setValueAtTime(0.4, t); g.gain.linearRampToValueAtTime(0, t+0.8); o.start(t); o.stop(t+0.8); }
                else if(type==='levelup') { o.type='square'; o.frequency.setValueAtTime(200, t); o.frequency.linearRampToValueAtTime(800, t+0.5); g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.5); o.start(t); o.stop(t+0.5); }
            }
        };

        class Star {
            constructor() { this.reset(true); }
            reset(r=false) { this.x=Math.random()*width; this.y=r?Math.random()*height:-10; this.z=Math.random()*2+0.5; this.a=Math.random()*0.5+0.1; }
            update() { this.y+=this.z*(0.5+(score*0.02)); if(this.y>height) this.reset(); }
            draw() { ctx.fillStyle=`rgba(255,255,255,${this.a})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.z*0.8, 0, 6.28); ctx.fill(); }
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        let width, height, gameState='MENU';
        let score=0, shields=0, cameraY=0, comboCount=0;
        let player, orbs=[], stars=[];
        window.gameScore = 0;

        class Player {
            constructor() { this.reset(); }
            reset() { this.x = width/2; this.y = height-200; this.vx=0; this.vy=0; this.radius=15; this.orbiting=true; this.currentOrb=null; this.angle=-Math.PI/2; this.trail=[]; this.attachTime=0; }
            update() {
                if(Math.random()>0.5) this.trail.push({x:this.x, y:this.y, l:1});
                this.trail.forEach(t=>t.l-=0.1); this.trail=this.trail.filter(t=>t.l>0);
                
                if(gameState==='RECOVERING') {
                     let target = null, minD = 99999;
                     orbs.forEach(o => { let d = Math.hypot(o.x - this.x, o.y - this.y); if(d < minD) { minD = d; target = o; } });
                     if(!target && orbs.length > 0) target = orbs[orbs.length-1];
                     if(target) {
                         this.x += (target.x - this.x) * 0.15; this.y += (target.y - this.y) * 0.15;
                         if(Math.hypot(target.x - this.x, target.y - this.y) < target.rad + 20) { 
                             attachPlayer(target); gameState='PLAYING'; spawnFloatingText(width/2, height/2, "Sƒ∞STEM AKTƒ∞F", "#00ff9d"); 
                         }
                     }
                     return;
                }

                if(this.orbiting && this.currentOrb) {
                    let speed = 0.04 + (score*0.0005); if(speed>0.1) speed=0.1;
                    this.angle += speed * this.currentOrb.dir;
                    this.x = this.currentOrb.x + Math.cos(this.angle)*this.currentOrb.rad;
                    this.y = this.currentOrb.y + Math.sin(this.angle)*this.currentOrb.rad;
                    this.rotation = this.angle + Math.PI/2*this.currentOrb.dir;
                } else {
                    this.x+=this.vx; this.y+=this.vy;
                    if(Math.abs(this.vx)>0.1 || Math.abs(this.vy)>0.1) this.rotation = Math.atan2(this.vy, this.vx);
                    if(this.x<-50 || this.x>width+50 || this.y>cameraY+height+100 || this.y<cameraY-500) {
                        trySavePlayer();
                    }
                }
            }
            draw() {
                let dy=this.y-cameraY;
                let currentTheme = THEMES[currentThemeIdx];
                let trailColor = gameState==='RECOVERING' ? '#00ff9d' : currentTheme.main;
                ctx.beginPath(); this.trail.forEach(t=>ctx.lineTo(t.x, t.y-cameraY)); ctx.strokeStyle=trailColor; ctx.lineWidth=2; ctx.stroke();
                ctx.save(); ctx.translate(this.x, dy); ctx.rotate(this.rotation);
                if(shields>0 && gameState==='PLAYING') { ctx.beginPath(); ctx.arc(0,0,25,0,6.28); ctx.strokeStyle=`rgba(0,255,157,${0.3+Math.sin(Date.now()*0.01)*0.2})`; ctx.lineWidth=2; ctx.stroke(); }
                ctx.beginPath(); ctx.moveTo(15,0); ctx.lineTo(-10,10); ctx.lineTo(-5,0); ctx.lineTo(-10,-10); ctx.fillStyle='#fff'; ctx.fill();
                ctx.restore();
            }
            jump() {
                if(this.orbiting) {
                    let timeSpent = Date.now() - this.attachTime;
                    if (timeSpent < 1500 && timeSpent > 50) {
                        comboCount++;
                        logHistory('üî•'); 
                        if(comboCount < 3) {
                            AudioSys.playSFX('combo');
                            spawnFloatingText(this.x, this.y - 50, `SERƒ∞ x${comboCount}`, "#ffaa00");
                        } else if (comboCount === 3) {
                            shields++; 
                            document.getElementById('shield-count').innerText=shields;
                            const sUI = document.getElementById('shield-ui'); sUI.classList.add('shield-active'); setTimeout(()=>sUI.classList.remove('shield-active'), 500);
                            spawnFloatingText(this.x, this.y - 80, "JOKER KAZANDIN!", "#00ff9d");
                            AudioSys.playSFX('shield_get');
                            comboCount = 0;
                        }
                    } else {
                        logHistory('üîµ');
                        if(comboCount > 0) spawnFloatingText(this.x, this.y - 50, "SERƒ∞ BOZULDU", "#ff5555");
                        comboCount = 0;
                    }
                    this.orbiting=false;
                    let p = 13 + score*0.05; if(p>22) p=22;
                    this.vx = Math.cos(this.rotation)*p; this.vy = Math.sin(this.rotation)*p;
                    AudioSys.playSFX('jump');
                }
            }
        }

        class Orb {
            constructor(y) { 
                this.y=y; this.rad=60+Math.random()*20; this.x=Math.random()*(width-this.rad*2)+this.rad; 
                this.dir=Math.random()>0.5?1:-1; 
                this.moving = false; this.shrinking = false;
                this.dx = (Math.random() * 1.5 + 0.5) * (Math.random()>0.5?1:-1);
                if(score >= 10) this.moving = Math.random() > 0.4;
                if(score >= 25) this.shrinking = Math.random() > 0.5;
            }
            update() {
                if(gameState !== 'PLAYING') return;
                if(this.moving) { this.x += this.dx; if(this.x < this.rad || this.x > width - this.rad) this.dx *= -1; }
                if(this.shrinking && this.rad > 25) this.rad -= 0.05;
            }
            draw() { 
                let dy=this.y-cameraY; if(dy<-200||dy>height+200) return; 
                let theme = THEMES[currentThemeIdx];
                ctx.beginPath(); ctx.arc(this.x, dy, this.rad, 0, 6.28); ctx.strokeStyle='#333'; ctx.lineWidth=3; ctx.stroke(); 
                ctx.beginPath(); ctx.arc(this.x, dy, this.rad-5, 0, 6.28); ctx.strokeStyle=theme.main; ctx.lineWidth=1; ctx.stroke(); 
                if(this.shrinking) { ctx.fillStyle='#ff0000'; ctx.beginPath(); ctx.arc(this.x, dy, 3, 0, 6.28); ctx.fill(); }
            }
        }

        function init() {
            width=window.innerWidth; height=window.innerHeight; canvas.width=width; canvas.height=height;
            player=new Player(); score=0; shields=0; comboCount=0; orbs=[]; stars=[]; window.gameScore=0; currentThemeIdx=0;
            gameHistory = [];
            for(let i=0; i<100; i++) stars.push(new Star());
            let start=new Orb(height-200); start.x=width/2; start.moving=false; start.shrinking=false; orbs.push(start);
            player.orbiting=true; player.currentOrb=start; player.angle=-Math.PI/2; 
            player.x = start.x; player.y = start.y - start.rad; player.attachTime = Date.now();
            cameraY=player.y-height/1.5; generateOrbs();
            document.getElementById('score').innerText=0; document.getElementById('shield-count').innerText=0;
            updateThemeUI();
        }

        function attachPlayer(o) { player.orbiting=true; player.currentOrb=o; player.angle=Math.atan2(player.y-o.y, player.x-o.x); player.attachTime = Date.now(); AudioSys.playSFX('dock'); }
        function generateOrbs() { let lastY=orbs.length>0?orbs[orbs.length-1].y:height; while(lastY > cameraY-height) { lastY-=250; orbs.push(new Orb(lastY)); } if(orbs[0].y-cameraY > height+400) orbs.shift(); }
        
        function updateThemeUI() {
            const theme = THEMES[currentThemeIdx];
            document.body.style.backgroundColor = theme.bg;
            document.getElementById('score').style.color = theme.main;
            document.getElementById('level-txt').innerText = theme.name;
        }

        function checkCols() { 
            if(player.orbiting) return; 
            orbs.forEach(o => { 
                if(Math.hypot(player.x-o.x, player.y-o.y) < o.rad) { 
                    if(player.currentOrb!==o) { 
                        attachPlayer(o); 
                        score++; window.gameScore=score; 
                        document.getElementById('score').innerText=score; 
                        let nextIdx = currentThemeIdx + 1;
                        if(nextIdx < THEMES.length && score >= THEMES[nextIdx].score) { currentThemeIdx = nextIdx; triggerLevelUp(currentThemeIdx); }
                    } 
                } 
            }); 
        }
        
        function trySavePlayer() {
            if(shields>0) {
                shields--; document.getElementById('shield-count').innerText=shields;
                AudioSys.playSFX('recover'); logHistory('üõ°Ô∏è');
                gameState='RECOVERING'; player.vx=0; player.vy=0;
                spawnFloatingText(width/2, height/2, "KURTARMA MODU!", "#00ff9d");
            } else { gameOver(); }
        }

        function gameOver() {
            gameState='GAMEOVER'; AudioSys.stopMusic(); AudioSys.playSFX('die');
            logHistory('üíÄ');
            
            let historyStr = gameHistory.slice(-10).join('');
            document.getElementById('share-preview').innerText = historyStr;

            let personalBest = localStorage.getItem('neonLeapBest') || 0;
            if (score > personalBest) { personalBest = score; localStorage.setItem('neonLeapBest', personalBest); }
            
            document.getElementById('final-score').innerText = score;
            document.getElementById('best-score').innerText = personalBest;

            document.getElementById('game-over-screen').classList.remove('hidden');
            document.getElementById('save-score-area').style.display = 'block';
        }

        function copyToClipboard() {
            let historyStr = gameHistory.slice(-10).join('');
            let text = `Neon Leap üöÄ\n${historyStr}\nSkor: ${score}`;
            const textArea = document.getElementById("clipboard-helper");
            textArea.value = text; textArea.select();
            try { document.execCommand("copy"); showToast("Kopyalandƒ±!"); } catch (err) {}
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); } 
            else { if (document.exitFullscreen) document.exitFullscreen(); }
        }

        function loop() {
            ctx.fillStyle=THEMES[currentThemeIdx].bg; ctx.fillRect(0,0,width,height);
            stars.forEach(s => { s.update(); s.draw(); });
            if(gameState==='PLAYING' || gameState==='RECOVERING') { player.update(); let tCam = player.y - height/1.8; if(tCam<cameraY) cameraY+=(tCam-cameraY)*0.1; if(gameState==='PLAYING') { generateOrbs(); checkCols(); } }
            orbs.forEach(o => { o.update(); o.draw(); });
            if(gameState === 'RECOVERING') {
                let target = orbs.find(o => Math.hypot(o.x - player.x, o.y - player.y) < 800) || orbs[orbs.length-1];
                if(target) {
                    ctx.beginPath(); ctx.moveTo(player.x, player.y-cameraY); ctx.lineTo(target.x, target.y-cameraY);
                    ctx.setLineDash([15, 15]); ctx.strokeStyle = '#00ff9d'; ctx.lineWidth = 4; ctx.stroke(); ctx.setLineDash([]);
                }
            }
            player.draw();
            if(gameState!=='GAMEOVER') requestAnimationFrame(loop);
        }

        document.getElementById('start-btn').addEventListener('click', ()=>{ AudioSys.init(); AudioSys.startMusic(); init(); gameState='PLAYING'; document.getElementById('start-screen').classList.add('hidden'); loop(); });
        document.getElementById('restart-btn').addEventListener('click', ()=>{ document.getElementById('game-over-screen').classList.add('hidden'); init(); gameState='PLAYING'; AudioSys.startMusic(); loop(); });
        document.getElementById('share-btn').addEventListener('click', copyToClipboard);
        document.getElementById('music-btn').addEventListener('click', (e) => { e.stopPropagation(); AudioSys.toggleMusic(); });
        document.getElementById('sfx-btn').addEventListener('click', (e) => { e.stopPropagation(); AudioSys.toggleSfx(); });
        document.getElementById('fullscreen-btn').addEventListener('click', (e) => { e.stopPropagation(); toggleFullScreen(); });

        window.addEventListener('mousedown', e=>{ if(e.target.tagName!=='BUTTON' && e.target.tagName!=='INPUT') if(gameState==='PLAYING') player.jump(); });
        window.addEventListener('touchstart', e=>{ if(e.target.tagName!=='BUTTON' && e.target.tagName!=='INPUT') {e.preventDefault(); if(gameState==='PLAYING') player.jump();} }, {passive:false});
        window.addEventListener('resize', ()=>{width=window.innerWidth; height=window.innerHeight; canvas.width=width; canvas.height=height;});
        
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText=msg; t.classList.add('show-toast'); setTimeout(()=>t.classList.remove('show-toast'), 2000); }
    </script>
</body>
</html>